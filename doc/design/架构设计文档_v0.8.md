# AI Project Management Platform - 架构设计文档 v0.8

> **版本说明**：基于v0.8需求设计的系统架构和技术选型  
> **核心原则**：把优秀的人的工作经验以Skill方式用于项目各环节  
> **产品架构**：Web平台 + CLI客户端 + AI工具集成

---

## 一、核心架构理念

### 1.1 设计原则

```
核心原则：优秀的人的经验 → Skill → 用于项目各环节

设计优先级：
├─ 1. Skill是参与者的核心资产               → 经验封装，可复用
├─ 2. 参与者自由选择AI工具                 → Claude/Cursor/Codex
├─ 3. 平台只验收成果，不关心过程           → 只看交付件
├─ 4. Skill可集成到AI工具                 → 直接在AI中使用
└─ 5. 社区可复用优秀Skill                 → 经验沉淀和分享
```

### 1.2 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          整体架构                                         │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Web平台层                                      │   │
│  │  ├─ 发起人：项目发布、验收管理、结算                              │   │
│  │  ├─ 参与者：任务大厅、个人档案、收益管理                          │   │
│  │  └─ 社区：Skill市场、技能评分、经验分享                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                      │
│                                    ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         CLI客户端层                                    │   │
│  │  ├─ 任务同步：从平台拉取任务到本地                                │   │
│  │  ├─ 成果提交：提交GitHub PR到平台                                │   │
│  │  ├─ 验收查看：查看发起人验收结果                                  │   │
│  │  └─ Skill管理：分享/导入Skill                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                      │
│                                    │                                      │
│              ┌────────────────────┼────────────────────┐              │
│              ▼                    ▼                    ▼              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐   │
│  │   Claude         │  │   Cursor        │  │   Codex/OpenCode│   │
│  │   (基于模型)     │  │   (基于模型)    │  │   (基于模型)    │   │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘   │
│              │                    │                    │              │
│              └────────────────────┼────────────────────┘              │
│                                    ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         参与者工作流                                  │   │
│  │                                                                     │   │
│  │  1. 从CLI/平台拉取任务                                            │   │
│  │  2. 在AI工具中加载Skill（自己的/社区的）                          │   │
│  │  3. 用Skill完成项目（经验驱动）                                    │   │
│  │  4. 提交GitHub PR                                                │   │
│  │  5. 平台验收成果                                                  │   │
│  │  6. 获得分成                                                       │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                      │
│                                    ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         数据持久层 (Prisma)                          │   │
│  │  ├─ 用户/项目/任务/结算                                           │   │
│  │  └─ Skill市场数据（分享/评分/复用）                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 核心角色与职责

| 角色 | 职责 | 核心资产 |
|------|------|----------|
| **发起人** | 发布项目、验收成果、支付分成 | 项目需求 |
| **参与者** | 用Skill完成项目、交付成果 | Skill（经验封装） |
| **平台** | 管理流程、验收标准、结算资金 | 流程和规则 |
| **社区** | 分享Skill、复用经验、沉淀知识 | Skill市场 |

---

## 二、Skill设计

### 2.1 Skill是什么

```
Skill定义：
├─ 是参与者的经验封装
├─ 包含：Prompt模板、工作流程、质量标准
├─ 可：复用、分享、集成到AI工具
└─ 用于：项目各环节

Skill不是：
├─ 不是平台提供的服务
├─ 不是调用API的封装
└─ 不是限制参与者工具
```

### 2.2 Skill核心组成

```typescript
interface Skill {
  // 基础信息
  id: string
  name: string                    // Skill名称
  description: string           // 功能描述
  author: User                   // 作者
  tags: string[]                // 标签：Python/React/API等
  
  // 核心组件
  promptTemplates: PromptTemplate[]  // Prompt模板集合
  workflow: Workflow              // 工作流程定义
  qualityStandard: QualityStandard // 质量标准
  
  // 元数据
  stats: {
    usageCount: number          // 使用次数
    successRate: number         // 验收通过率
    avgQualityScore: number      // 平均质量分
  }
  
  // 权限
  visibility: 'private' | 'community' | 'public'
  license: string               // 开源许可证
}
```

### 2.3 Skill示例

```
示例：Python RESTful API 开发Skill

Skill结构：
├─ 名称：Python RESTful API 开发专家
├─ 标签：[Python, FastAPI, RESTful, API Design]
├─ Prompt模板：
│  ├─ 基础模板：通用API开发Prompt
│  ├─ 数据库集成：SQLAlchemy集成模板
│  ├─ 认证模块：JWT认证模板
│  └─ 测试模板：pytest模板
├─ 工作流程：
│  ├─ 步骤1：分析API需求
│  ├─ 步骤2：设计数据模型
│  ├─ 步骤3：编写API代码
│  └─ 步骤4：编写测试用例
└─ 质量标准：
   ├─ PEP8规范
   ├─ 单元测试覆盖率 > 80%
   ├─ 错误处理完整
   └─ 文档齐全
```

### 2.3 Skill数据模型（JSON Schema）

```
核心原则：Skill使用JSON Schema定义，workflow为纯指导，无需自动化执行

Skill定义结构：
├─ 基础信息（name, description, tags）
├─ Prompt模板（支持变量替换）
├─ 工作流程（纯指导步骤）
└─ 质量标准（验收维度）

变量替换语法：Handlebars风格 {{variableName}}
```

#### 2.3.1 Skill JSON Schema

```typescript
interface SkillDefinition {
  // ========== 基础信息 ==========
  name: string           // Skill名称
  description: string     // 功能描述
  tags: string[]         // 标签：["Python", "FastAPI"]
  
  // ========== Prompt模板 ==========
  prompts: {
    role: "system" | "user" | "assistant"
    content: string      // Prompt模板，支持 {{variable}} 替换
    variables?: {        // 变量定义（可选）
      name: string
      description: string
      required?: boolean
      default?: string
    }[]
  }[]
  
  // ========== 工作流程（纯指导） ==========
  workflow: {
    step: number         // 步骤编号 1, 2, 3...
    name: string         // 步骤名称
    description: string  // 步骤说明
  }[]
  
  // ========== 质量标准 ==========
  qualityStandard: {
    criteria: {
      name: string       // 检查项名称
      weight: number     // 权重 0-1
      description: string
    }[]
    passingScore: number // 通过分数（4.0）
  }
  
  // ========== 元数据 ==========
  visibility: "private" | "community" | "public"
  license: string        // MIT, Apache等
}
```

#### 2.3.2 Skill数据存储

```typescript
model Skill {
  id          String @id @default(uuid())
  name        String
  authorId    String
  
  // Skill定义存为JSONB
  definition  Json   // SkillDefinition
  
  // 统计
  stats {
    usageCount: Int @default(0)
    successRate: Float @default(0)
    avgScore: Float @default(0)
  }
  
  // 元数据
  visibility  Visibility @default(COMMUNITY)
  license     String @default("MIT")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("skills")
}
```

#### 2.3.3 Skill示例（JSON格式）

```json
{
  "name": "Python RESTful API 开发专家",
  "description": "快速开发高质量RESTful API",
  "tags": ["Python", "FastAPI", "RESTful"],
  
  "prompts": [
    {
      "role": "system",
      "content": "你是一位专业的{{language}}开发者，擅长编写高质量、可维护的代码。",
      "variables": [
        {
          "name": "language",
          "description": "编程语言",
          "required": true,
          "default": "Python"
        }
      ]
    },
    {
      "role": "user",
      "content": "开发一个{{api_name}} API，要求：\n1. 使用{{framework}}框架\n2. 代码符合{{coding_standard}}规范\n3. 包含完整错误处理\n4. 编写单元测试\n5. 提供API文档",
      "variables": [
        {"name": "api_name", "description": "API名称", "required": true},
        {"name": "framework", "description": "开发框架", "default": "FastAPI"},
        {"name": "coding_standard", "description": "代码规范", "default": "PEP8"}
      ]
    }
  ],
  
  "workflow": [
    {"step": 1, "name": "分析需求", "description": "理解API功能需求"},
    {"step": 2, "name": "设计模型", "description": "设计数据模型和数据库结构"},
    {"step": 3, "name": "编写代码", "description": "实现API接口"},
    {"step": 4, "name": "编写测试", "description": "编写单元测试"}
  ],
  
  "qualityStandard": {
    "criteria": [
      {"name": "代码规范性", "weight": 0.3, "description": "符合代码规范"},
      {"name": "功能完整性", "weight": 0.4, "description": "需求功能完整实现"},
      {"name": "测试覆盖", "weight": 0.2, "description": "单元测试覆盖率>80%"},
      {"name": "文档完整", "weight": 0.1, "description": "API文档齐全"}
    ],
    "passingScore": 4.0
  },
  
  "visibility": "community",
  "license": "MIT"
}
```

#### 2.3.4 Prompt变量替换示例

```
原始Prompt：
"开发一个{{api_name}} API，使用{{framework}}框架"

变量定义：
- api_name: API名称（必填）
- framework: 开发框架（可选，默认FastAPI）

执行时：
├─ 输入：{ api_name: "用户认证", framework: "FastAPI" }
├─ 替换后："开发一个用户认证 API，使用FastAPI框架"
└─ 发送给AI
```

### 2.4 Skill与AI工具集成

```
集成方式：基于模型能力直接运行

参与者操作：
1. 在Claude Desktop中直接使用Skill的Prompt模板
   └─ 复制Prompt模板到对话中

2. 在Cursor中导入Skill
   └─ 作为代码生成参考规则

3. 在OpenCode中集成Skill
   └─ 作为开发模板参考

效果：
参与者用习惯的工具
+ 加载优秀Skill（Prompt模板）
= 高质量产出

注：不依赖MCP协议，Skill本身基于模型能力运行
脚本/MCP等可通过Skill触发执行
```

---

## 三、技术选型

### 3.1 最终技术栈

| 层级 | 技术选型 | 版本 | 选型理由 |
|------|----------|------|----------|
| **前端框架** | Vue 3 | 3.4+ | 模板语法AI友好，生成代码规范 |
| **前端语言** | TypeScript | 5.0+ | 类型安全 |
| **UI组件库** | Naive UI | 2.7+ | Vue生态友好，主题配置灵活 |
| **状态管理** | Pinia | 2.0+ | API简洁 |
| **后端框架** | Fastify | 4.0+ | 高性能 |
| **后端语言** | TypeScript | 5.0+ | 与前端统一 |
| **ORM** | Prisma | 5.0+ | 类型安全，IDE提示好 |
| **数据库** | PostgreSQL | 15+ | 生产级，JSON支持好 |
| **认证** | JWT + GitHub OAuth | - | 无状态+代码仓库绑定 |
| **部署** | Docker | 24+ | 一键部署 |
| **CLI工具** | Node.js + Commander.js | - | TypeScript统一 |
| **国际化** | vue-i18n | 9.0+ | 中英文支持 |
| **监控** | Prometheus + Grafana | - | 指标监控+可视化 |

### 3.2 技术栈优势

| 优势 | 说明 |
|------|------|
| **Vue模板AI友好** | template语法规范，AI生成代码质量高 |
| **TypeScript统一** | 前后端+CLI都是TS，降低认知负担 |
| **PostgreSQL** | JSON支持好，直接存Skill定义 |
| **GitHub OAuth** | 发起人授权仓库，无需参与者绑定账号 |
| **开箱即用** | Docker一键部署，无需复杂配置 |
| **国际化** | vue-i18n支持中英文无缝切换 |

### 3.3 对比之前版本

| 维度 | v0.6 | v0.7 | v0.8 |
|------|-------|-------|------|
| **Skill定位** | 平台封装AI调用 | 参与者经验封装 | 参与者经验封装 |
| **参与者工具** | 通过Skill调用AI | 自由选择AI工具 | 自由选择AI工具 |
| **平台职责** | 转发Skill调用 | 只验收成果 | 只验收成果 |
| **AI集成** | Direct SDK | 基于模型能力运行 | 基于模型能力运行 |
| **Skill执行** | 依赖外部框架 | Skill本身即运行时 | Skill本身即运行时 |
| **数据库** | 未明确 | SQLite+PostgreSQL | 直接PostgreSQL |
| **前端框架** | 未明确 | Vue 3 | Vue 3（AI友好） |
| **国际化** | 无 | 无 | 中英文支持 |
| **监控** | 无 | 无 | Prometheus+Grafana |

### 2.5 CLI客户端设计

```
CLI客户端功能：
├─ 任务管理
│  ├─ aipm task list              # 列出可认领任务
│  ├─ aipm task claim <id>       # 认领任务
│  ├─ aipm task pull             # 同步任务到本地
│  └─ aipm task submit           # 标记任务完成（附带仓库地址）
│
├─ Skill管理
│  ├─ aipm skill list            # 列出我的Skill
│  ├─ aipm skill create          # 创建Skill
│  ├─ aipm skill export <id>     # 导出Prompt模板
│  └─ aipm skill import <file>   # 导入Skill
│
├─ 项目管理
│  ├─ aipm project list           # 列出我的项目
│  └─ aipm project info <id>     # 项目详情
│
└─ 验收查询
   ├─ aipm review status          # 查看验收状态
   └─ aipm review result          # 查看验收结果

CLI工作流：
1. aipm task list                # 查看任务大厅
2. aipm task claim <id>          # 认领任务
3. aipm task pull                # 同步任务到本地
4. 在AI工具中使用Skill完成交付    # Claude/Cursor/Codex
5. aipm task submit              # 标记完成（附仓库地址）
```

### 3.2 技术栈优势

| 优势 | 说明 |
|------|------|
| **TypeScript统一** | 前后端+CLI都是TS，降低认知负担 |
| **SQLite开发** | 免安装，秒启动，一人开发友好 |
| **Vue 3** | 学习成本低，文档友好 |
| **MCP集成** | 标准化AI工具集成 |
| **CLI优先** | 对开发者友好，浏览器兼容问题少 |

---

## 四、数据模型设计

### 4.1 核心数据表

#### 4.1.1 用户表 (users)

```typescript
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String
  avatar        String?
  role          Role      @default(PARTICIPANT)
  status        UserStatus @default(ACTIVE)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  skills        Skill[]   @relation("SkillAuthor")
  usedSkills    SkillUsage[]
  projects      Project[]  @relation("ProjectInitiator")
  tasks         Task[]
  settlements   Settlement[]
  
  @@map("users")
}

enum Role {
  INITIATOR    // 发起人
  PARTICIPANT  // 参与者
  ADMIN        // 管理员
}

enum UserStatus {
  ACTIVE
  INACTIVE
}
```

#### 4.1.2 Skill表 (skills)

```typescript
model Skill {
  id            String    @id @default(uuid())
  name          String
  description   String
  tags          String[]
  
  // Prompt模板
  promptTemplates Json    // 序列化存储
  
  // 工作流程定义
  workflow       Json
  
  // 质量标准
  qualityStandard Json
  
  // 元数据
  visibility     Visibility @default(COMMUNITY)
  license        String     @default("MIT")
  
  authorId       String
  author         User       @relation("SkillAuthor", fields: [authorId], references: [id])
  
  // 统计
  stats {
    usageCount:     Int       @default(0)
    successRate:    Float     @default(0)
    avgQualityScore: Float   @default(0)
  }
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  usages        SkillUsage[]
  
  @@map("skills")
}

enum Visibility {
  PRIVATE     // 仅自己可见
  COMMUNITY  // 社区可见
  PUBLIC     // 公开
}
```

#### 4.1.3 Skill使用记录表 (skill_usages)

```typescript
model SkillUsage {
  id            String    @id @default(uuid())
  skillId       String
  skill         Skill     @relation(fields: [skillId], references: [id])
  
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  
  taskId        String?
  task          Task?     @relation(fields: [taskId], references: [id])
  
  // 使用情况
  qualityScore   Float?    // 本次质量评分
  wasApproved    Boolean   @default(false)
  
  usedAt        DateTime  @default(now())
  
  @@map("skill_usages")
}

#### 4.1.5a 验收标准Skill表 (review_standards)

```typescript
model ReviewStandard {
  id            String    @id @default(uuid())
  name          String    // Skill名称
  authorId      String
  author        User      @relation(fields: [authorId], references: [id])
  
  // 类型
  type          ReviewStandardType @default(COMMUNITY)
  license       String    @default("MIT")
  repoUrl       String?   // 开源仓库地址
  
  // 验收标准
  criteria      Json      // 检查项列表
  weights       Float[]   // 各项权重
  minScore     Float     @default(4.0) // 最低通过分数
  
  // 自动化
  automation    AutomationLevel @default(MANUAL)
  autoTools    String[]  // 自动化工具
  
  // 统计
  usageCount   Int       @default(0)
  avgScore     Float?
  
  // 状态
  status        ReviewStandardStatus @default(DRAFT)
  isVerified    Boolean   @default(false) // 平台审核
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("review_standards")
}

enum ReviewStandardType {
  OFFICIAL    // 平台官方
  COMMUNITY   // 社区贡献
  CUSTOM      // 自定义
}

enum AutomationLevel {
  MANUAL      // 纯人工
  SEMI_AUTO   // 半自动
  AUTO        // 全自动
}

enum ReviewStandardStatus {
  DRAFT
  PUBLISHED
  DEPRECATED
}

#### 4.1.5b 项目验收标准关联表 (project_review_standards)

```typescript
model ProjectReviewStandard {
  id              String    @id @default(uuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id])
  
  reviewStandardId String
  reviewStandard  ReviewStandard @relation(fields: [reviewStandardId], references: [id])
  
  // 项目特定配置
  customCriteria  Json?     // 自定义检查项
  customWeights  Float[]   // 自定义权重
  
  // 环节关联
  milestoneIds    String[]  // 适用的环节ID列表
  
  createdAt       DateTime  @default(now())
  
  @@unique([projectId, reviewStandardId])
  @@map("project_review_standards")
}

#### 4.1.5c 验收记录表 (task_reviews)

```typescript
model TaskReview {
  id              String    @id @default(uuid())
  taskId          String
  task            Task      @relation(fields: [taskId], references: [id])
  
  reviewStandardId String
  reviewStandard  ReviewStandard @relation(fields: [reviewStandardId], references: [id])
  
  // 验收结果
  scores          Float[]   // 各项评分
  totalScore      Float     // 总分
  
  // 自动化检查结果
  autoCheckResults Json?    // 自动化工具检查结果
  
  // 人工评价
  reviewerId      String?   // 验收人（发起人或指定）
  comment         String?   // 评价说明
  
  // 验收操作
  result          ReviewResult
  requiresRevision Boolean  @default(false)
  revisionReason  String?
  
  createdAt       DateTime  @default(now())
  
  @@map("task_reviews")
}

enum ReviewResult {
  APPROVED
  REJECTED
  REVISION_REQUIRED
}

#### 4.1.7 信用历史记录表（核心：没有权威，只有历史）

```typescript
// 信用来源 = 历史记录总和
// 记录一旦写入不可修改，谁都看得见

// 4.1.7a 用户信用历史记录
model UserCreditHistory {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  // 信用类型
  creditType       CreditType
  
  // 信用变化
  change          Float     // 变化值（正/负）
  previousScore   Float     // 变化前分数
  newScore        Float     // 变化后分数
  
  // 来源
  sourceType      SourceType  // 来源类型
  sourceId        String?     // 来源ID（项目/Skill/验收标准等）
  sourceName      String?     // 来源名称（便于展示）
  
  // 附加信息
  description     String?     // 描述
  metadata        Json?       // 附加数据
  
  // 记录不可篡改
  createdAt       DateTime  @default(now())
  
  @@index([userId, creditType])
  @@map("user_credit_history")
}

enum CreditType {
  PARTICIPANT_CREDIT   // 参与者信用
  INITIATOR_CREDIT    // 发起人信用
  SKILL_CREDIT        // Skill信用
  REVIEW_STANDARD_CREDIT // 验收标准信用
}

enum SourceType {
  PROJECT_COMPLETED    // 项目完成
  TASK_APPROVED       // 任务验收通过
  TASK_REJECTED       // 任务验收拒绝
  GOOD_REVIEW         // 好评
  BAD_REVIEW          // 差评
  PUNISHMENT          // 惩罚
  REPORT              // 举报（对方被惩罚）
}

// 4.1.7b 用户当前信用快照（便于快速查询）
model UserCreditSnapshot {
  userId          String    @id @default(uuid())
  user            User      @relation(fields: [userId], references: [id])
  
  // 各维度信用
  participantScore Float     @default(0)  // 参与者信用
  initiatorScore  Float     @default(0)   // 发起人信用
  
  // 统计
  totalProjects   Int       @default(0)   // 参与项目数
  completedTasks  Int       @default(0)   // 完成任务数
  approvalRate    Float     @default(0)   // 验收通过率
  goodReviewRate  Float     @default(0)   // 好评率
  
  // 惩罚记录
  punishmentCount Int       @default(0)   // 被惩罚次数
  
  // 时间戳
  updatedAt      DateTime  @updatedAt
  
  @@map("user_credit_snapshots")
}

// 4.1.7c Skill信用历史记录
model SkillCreditHistory {
  id              String    @id @default(uuid())
  skillId         String
  
  // 信用变化
  change          Float
  previousScore   Float
  newScore        Float
  
  // 来源
  sourceType      SourceType
  sourceId        String?   // 使用该Skill的任务ID
  sourceName      String?   // 项目名称
  
  description     String?
  
  createdAt       DateTime  @default(now())
  
  @@index([skillId])
  @@map("skill_credit_history")
}

// 4.1.7d Skill信用快照
model SkillCreditSnapshot {
  skillId         String    @id
  
  // 统计
  usageCount      Int       @default(0)   // 使用次数
  approvalRate    Float     @default(0)   // 验收通过率
  goodReviewRate  Float     @default(0)   // 好评率
  averageScore    Float     @default(0)   // 平均评分
  
  updatedAt      DateTime  @updatedAt
  
  @@map("skill_credit_snapshots")
}

// 4.1.7e 社区治理记录（举证-惩罚机制）
model GovernanceRecord {
  id              String    @id @default(uuid())
  
  // 举报类型
  reportType      ReportType
  
  // 举报内容
  targetId        String    // 被举报人ID
  targetType      TargetType
  evidence        String    // 证据描述
  evidenceUrls    String[]  // 证据链接
  
  // 处理结果
  status          GovernanceStatus @default(PENDING)
  decision        String?   // 处理决定
  punishType      PunishType? // 惩罚类型
  punishDuration  Int?      // 惩罚时长（天）
  
  // 举证者
  reporterId      String
  
  // 社区投票
  supportVotes    Int       @default(0)   // 支持举报
  opposeVotes     Int       @default(0)   // 反对举报
  
  // 时间戳
  reportedAt      DateTime  @default(now())
  resolvedAt      DateTime?
  
  @@map("governance_records")
}

enum ReportType {
  FAKE_TRANSACTION   // 虚假交易
  PLAGIARISM        // 抄袭洗稿
  MALICIOUS_REVIEW  // 恶意差评
  FAKE_REVIEW       // 刷好评
  OTHER             // 其他
}

enum TargetType {
  USER
  SKILL
  REVIEW_STANDARD
}

enum GovernanceStatus {
  PENDING     // 待处理
  VOTING      // 投票中
  RESOLVED    // 已解决
  DISMISSED   // 驳回
}

enum PunishType {
  WARNING     // 警告
  FREEZE      // 冻结
  BAN         // 封禁
  PUBLIC_SHAME // 公开记录
}

#### 4.1.8 信用查询API

```typescript
// 查询用户的信用历史
GET /api/users/:id/credit-history

// 查询用户的信用快照
GET /api/users/:id/credit-snapshot

// 查询Skill的信用历史
GET /api/skills/:id/credit-history

// 查询Skill的信用快照
GET /api/skills/:id/credit-snapshot

// 查询治理记录
GET /api/governance?status=resolved

// 提交举报
POST /api/governance/report
```

#### 4.1.9 信用算法设计原则

```
信用计算原则：
├─ 时间衰减：越近的行为权重越高
├─ 成功溢价：完成项目权重 > 未完成
├─ 好评加成：好评 + 信用，差评 - 信用
├─ 惩罚倍增：一次作恶代价 >> 收益
└─ 多维度：数量、质量、好评率分开计算

具体公式：
├─ 参与者信用 = 完成率×40 + 质量分×40 + 好评率×20
├─ Skill信用 = 采用数×0.3 + 通过率×0.5 + 好评率×0.2
└─ 发起人信用 = 完成率×0.5 + 好评率×0.3 + 惩罚次数×-0.2
```

#### 4.1.10 历史记录不可篡改

```
实现方式：
├─ 所有记录写入后不可修改
├─ 所有记录公开透明
├─ 任何人都可以查询历史
└─ 信用由历史写就，没有权威

查询权限：
├─ 发起人可查参与者历史
├─ 参与者可查发起人历史
├─ 任何人可查Skill历史
└─ 任何人可查验收标准历史
```

#### 4.1.6 项目表 (projects)

#### 4.1.4 项目表 (projects)

```typescript
model Project {
  id            String    @id @default(uuid())
  title         String
  description   String
  mode          ProjectMode @default(COMMUNITY)
  visibility    Visibility @default(PUBLIC)
  status        ProjectStatus @default(DRAFT)
  
  totalBudget   Float
  costPerTask   Float?
  
  initiatorId   String
  initiator     User      @relation("ProjectInitiator", fields: [initiatorId], references: [id])
  
  milestones    Milestone[]
  tasks         Task[]
  settlements   Settlement[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("projects")
}

enum ProjectMode {
  COMMUNITY   // 现金
  ENTERPRISE  // 积分
}

enum Visibility {
  PUBLIC
  PRIVATE
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}
```

#### 4.1.5 任务表 (tasks)

```typescript
model Task {
  id            String    @id @default(uuid())
  status        TaskStatus @default(PENDING)
  
  milestoneId   String
  milestone     Milestone  @relation(fields: [milestoneId], references: [id])
  
  assigneeId    String
  assignee      User       @relation(fields: [assigneeId], references: [id])
  
  // 参与者使用的Skill（记录）
  usedSkills    String[]  // Skill ID列表
  
  // 交付信息
  deliverableUrl String?   // GitHub PR/仓库URL
  qualityScore  Float?    // 验收评分
  
  // 时间戳
  startedAt      DateTime?
  submittedAt    DateTime?
  approvedAt     DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("tasks")
}

enum TaskStatus {
  PENDING      // 待认领
  IN_PROGRESS  // 进行中
  SUBMITTED    // 已提交
  APPROVED     // 已通过验收
  REJECTED     // 验收被拒
  CANCELLED     // 已取消
}
```

#### 4.1.6 结算表 (settlements)

```typescript
model Settlement {
  id            String    @id @default(uuid())
  projectId     String
  project       Project    @relation(fields: [projectId], references: [id])
  
  userId        String
  user          User       @relation(fields: [userId], references: [id])
  
  taskId        String?
  task          Task?      @relation(fields: [taskId], references: [id])
  
  amount        Float
  currency      String    @default("CNY")
  
  status        SettlementStatus @default(PENDING)
  
  settledAt     DateTime?
  createdAt     DateTime  @default(now())
  
  @@map("settlements")
}

enum SettlementStatus {
  PENDING
  COMPLETED
  FAILED

#### 4.1.11 初始信用评估表（解决冷启动）

```typescript
// 4.1.11a 初始信用Skill表
model InitialCreditSkill {
  id            String    @id @default(uuid())
  name          String    // Skill名称
  authorId      String
  author        User      @relation(fields: [authorId], references: [id])
  
  // 类型
  type          InitialCreditSkillType @default(COMMUNITY)
  license       String    @default("MIT")
  repoUrl       String?   // 开源仓库地址
  
  // 评价维度
  dimensions      Json      // 技能测试、作品集、同行评议等
  
  // 计算公式
  calculation    Json      // 初始分计算公式
  
  // 统计
  usageCount    Int       @default(0)
  avgInitialScore Float?
  
  // 状态
  status        InitialCreditSkillStatus @default(DRAFT)
  isVerified    Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("initial_credit_skills")
}

enum InitialCreditSkillType {
  OFFICIAL
  COMMUNITY
}

enum InitialCreditSkillStatus {
  DRAFT
  PUBLISHED
  DEPRECATED
}

// 4.1.11b 用户初始信用记录
model UserInitialCredit {
  userId          String    @id
  user            User      @relation(fields: [userId], references: [id])
  skillId         String
  skill           InitialCreditSkill @relation(fields: [skillId], references: [id])
  
  skillTestScore  Float?    // 技能测试分数
  portfolioScore   Float?    // 作品集分数
  peerReviewScore  Float?    // 同行评议分数
  
  initialScore     Float     // 加权总分
  evaluatedAt     DateTime  @default(now())
  expiresAt       DateTime   // 过期时间（3-6个月）
  
  @@map("user_initial_credits")
}

// 4.1.11c 技能测试记录
model SkillTestResult {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  testType        String
  score           Float
  totalQuestions  Int
  correctAnswers  Int
  details         Json
  skillId         String
  createdAt       DateTime  @default(now())
  
  @@index([userId, testType])
  @@map("skill_test_results")
}

// 4.1.11d 作品集评估记录
model PortfolioEvaluation {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  portfolioUrl    String
  evaluationType  EvaluationType
  aiScore         Float?
  aiAnalysis      Json?
  manualReview    Boolean   @default(false)
  manualScore     Float?
  manualComment   String?
  reviewerId      String?
  skillId         String
  createdAt       DateTime  @default(now())
  
  @@map("portfolio_evaluations")
}

enum EvaluationType {
  AI_AUTO
  MANUAL
  HYBRID
}

// 4.1.11e 同行评议记录
model PeerReviewResult {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  reviewerId      String
  reviewer        User      @relation(fields: [reviewerId], references: [id])
  score           Float
  comment         String?
  reviewerMinCredit Float
  skillId         String
  createdAt       DateTime  @default(now())
  
  @@unique([userId, reviewerId, skillId])
  @@map("peer_review_results")
}

// 4.1.11f 最终信用计算
model UserFinalCredit {
  userId          String    @id
  user            User      @relation(fields: [userId], references: [id])
  initialScore     Float
  initialWeight    Float     @default(1.0)
  initialExpiresAt DateTime?
  longTermScore   Float
  finalScore      Float
  calculatedAt    DateTime  @default(now())
  
  @@map("user_final_credits")
}
```

#### 4.1.12 初始信用查询API

```typescript
GET /api/v1/users/:id/initial-credit
GET /api/v1/initial-credit-skills
POST /api/v1/users/:id/skill-test
POST /api/v1/users/:id/portfolio
GET /api/v1/users/:id/peer-reviews
GET /api/v1/users/:id/final-credit
```

#### 4.1.13 初始信用计算公式示例

```typescript
// @ai-pm/initial-credit 官方初始信用Skill
const officialInitialCreditSkill = {
  name: "@ai-pm/initial-credit",
  dimensions: {
    skillTest: { weight: 0.4, testTypes: ["python", "javascript"] },
    portfolio: { weight: 0.4, evaluationType: "AI_AUTO" },
    peerReview: { weight: 0.2, minReviewerCredit: 100 }
  },
  calculateInitialScore: (scores) => {
    return scores.skillTestScore * 0.4 + scores.portfolioScore * 0.4 + scores.peerReviewScore * 0.2
  }
}

// 最终信用计算（初始信用随时间衰减）
const calculateFinalCredit = (initialScore, longTermScore, months) => {
  const initialWeight = Math.max(1.0 - (months - 3) * 0.1, 0.1)
  return initialScore * initialWeight + longTermScore * (1.0 - initialWeight)
}
```


---

## 五、v0.8新增：平台抽成与结算机制

### 5.1 抽成规则

```
平台抽成规则：
├─ 社区模式：5%
│  ├─ 发起人支付 ¥100
│  └─ 参与者获得 ¥95
│
└─ 企业模式：3%
    ├─ 发起人支付 ¥100
    └─ 参与者获得 ¥97

抽成用途：
├─ 平台运营成本：60%
├─ 社区治理基金：20%
├─ Skill审核：10%
└─ 法律合规：10%
```

### 5.2 抽成数据模型

```typescript
// 5.2.1 结算表（含抽成）
model Settlement {
  id              String    @id @default(uuid())
  projectId       String
  project         Project    @relation(fields: [projectId], references: [id])
  
  userId          String
  user            User       @relation(fields: [userId], references: [id])
  
  taskId          String?
  task            Task?      @relation(fields: [taskId], references: [id])
  
  // 金额明细
  grossAmount     Float      // 原始金额
  platformFee     Float      // 平台抽成
  netAmount       Float      // 净额（参与者和发起人获得）
  
  // 抽成明细
  feeBreakdown    Json?      // 抽成细项
  // {
  //   "operation": 60%,      // 平台运营
  //   "governance": 20%,    // 社区治理
  //   "skill_audit": 10%,   // Skill审核
  //   "legal": 10%          // 法律合规
  // }
  
  currency        String    @default("CNY")
  status          SettlementStatus @default(PENDING)
  
  settledAt       DateTime?
  createdAt       DateTime  @default(now())
  
  @@map("settlements")
}

// 5.2.2 平台收入统计
model PlatformRevenue {
  id              String    @id @default(uuid())
  
  // 收入类型
  revenueType     RevenueType
  
  // 金额
  amount          Float
  currency        String    @default("CNY")
  
  // 来源
  fromProjectId   String?
  fromUserId     String?
  
  // 分配
  allocation      Json?     // 收入分配明细
  
  // 时间
  revenueDate     DateTime  @default(now())
  month           String    // 格式: YYYY-MM
  
  @@map("platform_revenues")
}

enum RevenueType {
  PLATFORM_FEE    // 平台抽成
  SKILL_SALE      // Skill销售（未来）
  VERIFICATION    // 认证费用（未来）
}

enum SettlementStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// 5.2.3 抽成计算公式
const calculatePlatformFee = (amount: number, mode: ProjectMode): { fee: number; net: number } => {
  const feeRate = mode === 'COMMUNITY' ? 0.05 : 0.03
  const fee = Math.round(amount * feeRate * 100) / 100
  const net = amount - fee
  return { fee, net }
}
```

### 5.3 抽成查询API

```typescript
// 查询结算记录
GET /api/v1/settlements?userId=xxx

// 查询平台收入统计
GET /api/v1/admin/revenue?month=2026-02

// 结算详情
GET /api/v1/settlements/:id
```

---

## 六、v0.8新增：争议仲裁机制

### 6.1 仲裁流程

```
争议触发：发起人和参与者对验收结果有分歧
    │
    ▼
Step 1：双方协商（24小时内）
    │
    ▼
Step 2：协商不成 → 发起仲裁
    │
    ├── 参与者提交证据
    ├── 发起人提交证据
    └── 平台介入审核
    │
    ▼
Step 3：平台仲裁结果
    ├── 维持发起人决定
    ├── 推翻发起人决定（参与者胜诉）
    └── 部分退款（各退一步）
    │
    ▼
Step 4：信用记录
    ├── 胜诉方信用 +10
    └── 败诉方信用 -5
```

### 6.2 仲裁数据模型

```typescript
// 6.2.1 争议表
model Dispute {
  id              String    @id @default(uuid())
  
  // 关联
  projectId       String
  project         Project    @relation(fields: [projectId], references: [id])
  
  taskId          String
  task            Task       @relation(fields: [taskId], references: [id])
  
  // 争议方
  initiatorId     String     // 发起争议者（参与者）
  initiator       User       @relation(fields: [initiatorId], references: [id])
  
  respondentId    String     // 应诉方（发起人）
  respondent      User       @relation(fields: [respondentId], references: [id])
  
  // 争议内容
  reason         String     // 争议原因
  initiatorEvidence String?  // 发起方证据
  respondentEvidence String? // 应诉方证据
  
  // 平台仲裁
  arbitratorId    String?    // 仲裁员
  arbitrator      User?      @relation(fields: [arbitratorId], references: [id])
  
  decision       DisputeDecision?  // 仲裁决定
  decisionReason  String?    // 仲裁理由
  
  // 金额处理
  refundAmount   Float?     // 退还金额
  penaltyAmount  Float?     // 惩罚金额
  
  // 时间
  status        DisputeStatus @default(OPEN)
  
  createdAt     DateTime  @default(now())
  respondedAt   DateTime?  // 应诉时间
  arbitratedAt  DateTime?  // 仲裁时间
  closedAt      DateTime?  // 关闭时间
  
  @@map("disputes")
}

enum DisputeStatus {
  OPEN          // 开放（双方举证中）
  EVIDENCE     // 证据已提交，待仲裁
  ARBITRATING  // 仲裁中
  CLOSED       // 已关闭
}

enum DisputeDecision {
  SUSTAIN_INITIATOR    // 维持发起人决定
  OVERTURN_INITIATOR   // 推翻发起人决定（参与者胜诉）
  COMPROMISE          // 各退一步（部分退款）
}

// 6.2.2 争议证据表
model DisputeEvidence {
  id              String    @id @default(uuid())
  
  disputeId       String
  dispute         Dispute   @relation(fields: [disputeId], references: [id])
  
  // 证据方
  submitterId     String
  submitter       User      @relation(fields: [submitterId], references: [id])
  
  // 证据内容
  type            EvidenceType
  description     String
  evidenceUrls    String[]
  
  // 时间
  submittedAt     DateTime  @default(now())
  
  @@map("dispute_evidence")
}

enum EvidenceType {
  CODE           // 代码证据
  COMMUNICATION  // 沟通记录
  SCREENSHOT     // 截图
  LINK           // 链接
  OTHER          // 其他
}

// 6.2.3 仲裁员表（可选，未来扩展）
model Arbitrator {
  userId          String    @id
  user            User      @relation(fields: [userId], references: [id])
  
  // 资质
  casesHandled    Int       @default(0)    // 处理案件数
  accuracyRate    Float     @default(0)    // 准确率
  
  // 收入
  totalEarnings   Float     @default(0)
  
  @@map("arbitrators")
}
```

### 6.3 仲裁API

```typescript
// 发起争议
POST /api/v1/disputes
{
  taskId: "xxx",
  reason: "xxx",
  evidence: [...]
}

// 应诉
POST /api/v1/disputes/:id/respond
{
  evidence: [...]
}

// 仲裁（管理员）
POST /api/v1/disputes/:id/arbitrate
{
  decision: "COMPROMISE",
  decisionReason: "xxx",
  refundAmount: 600
}

// 查询争议
GET /api/v1/disputes?status=OPEN
```

---

## 七、v0.8新增：防作弊机制

### 7.1 防作弊策略

```
防作弊策略：
├─ 技能测试
│  ├─ 防作弊：限时+随机题库+录像
│  └─ 多次取最高（避免发挥失常）
│
├─ 作品集评估
│  ├─ 防作弊：AI检测代码相似度
│  ├─ 防作弊：Git提交历史验证
│  └─ 人工抽查
│
└─ 同行评议
    ├─ 防作弊：评议人需信用>=100
    ├─ 防作弊：同一评议人最多评议3次/天
    └─ 防作弊：匿名评议
```

### 7.2 防作弊数据模型

```typescript
// 7.2.1 技能测试记录（扩展）
model SkillTestResult {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  testType        String
  testUrl         String    // 测试链接
  
  // 测试结果
  score           Float
  totalQuestions  Int
  correctAnswers  Int
  
  // 防作弊数据
  antiCheat       Json?     // 防作弊数据
  // {
  //   "duration": 1800,        // 测试时长（秒）
  //   "tabSwitches": 5,       // 切换标签次数
  //   "copyAttempts": 2,       // 复制尝试次数
  //   "screenshotCount": 1,    // 截屏次数
  //   "faceVerified": true,    // 人脸验证
  //   "browserVerified": true,  // 浏览器验证
  //   "ipConsistent": true     // IP一致性
  // }
  
  suspicious      Boolean   @default(false)  // 是否可疑
  flaggedAt       DateTime?
  
  skillId         String
  createdAt       DateTime  @default(now())
  
  @@index([userId, testType])
  @@map("skill_test_results")
}

// 7.2.2 作品集验证记录
model PortfolioVerification {
  id              String    @id @default(uuid())
  
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  portfolioUrl    String
  
  // 验证结果
  verificationType VerificationType
  result          VerificationResult
  
  // AI分析
  aiAnalysis      Json?     // AI分析结果
  // {
  //   "similarity": 0.15,       // 与其他作品相似度
  //   "complexity": 85,         // 复杂度评分
  //   "originality": 90,        // 原创性评分
  //   "quality": 88              // 质量评分
  // }
  
  // Git验证
  gitVerified     Boolean   @default(false)
  commitHistory   Json?     // 提交历史
  
  // 人工复核
  manualReview    Boolean   @default(false)
  reviewerId      String?
  reviewResult    String?
  
  createdAt       DateTime  @default(now())
  
  @@map("portfolio_verifications")
}

enum VerificationType {
  AI_AUTO
  MANUAL
  HYBRID
}

enum VerificationResult {
  PASS
  FAIL
  SUSPICIOUS
  NEED_REVIEW
}

// 7.2.3 同伴评议限制
model PeerReviewLimit {
  id              String    @id @default(uuid())
  
  reviewerId      String
  reviewer        User      @relation(fields: [reviewerId], references: [id])
  
  // 限制
  limitType       ReviewLimitType
  
  // 计数
  dailyCount      Int       @default(0)
  dailyLimit      Int       @default(3)  // 每天最多3次
  
  // 时间
  date           DateTime  @default(now())
  
  @@unique([reviewerId, date, limitType])
  @@map("peer_review_limits")
}

enum ReviewLimitType {
  DAILY_COUNT    // 每日评议数量
  RECENT_COUNT   // 最近7天评议数量
}

// 7.2.4 作弊举报记录
model CheatingReport {
  id              String    @id @default(uuid())
  
  // 被举报人
  reportedUserId  String
  reportedUser    User      @relation(fields: [reportedUserId], references: [id])
  
  // 举报人
  reporterId      String
  reporter        User      @relation(fields: [reporterId], references: [id])
  
  // 举报内容
  reportType     CheatingType
  evidence       String
  evidenceUrls   String[]
  
  // 处理结果
  status         CheatingReportStatus @default(PENDING)
  investigation  String?
  result        String?
  
  // 时间
  reportedAt     DateTime  @default(now())
  resolvedAt     DateTime?
  
  @@map("cheating_reports")
}

enum CheatingType {
  TEST_CHEATING     // 测试作弊
  PORTFOLIO_FAKE    // 作品集造假
  FAKE_REVIEW       // 虚假评议
  OTHER             // 其他
}

enum CheatingReportStatus {
  PENDING
  INVESTIGATING
  CONFIRMED
  DISMISSED
}
```

### 7.4 防作弊API

```typescript
// 提交技能测试
POST /api/v1/skill-tests
{
  testType: "python",
  score: 85,
  antiCheat: {...}
}

// 获取作品集验证
GET /api/v1/portfolios/:id/verification

// 提交同伴评议
POST /api/v1/peer-reviews
{
  userId: "xxx",
  score: 4.5,
  comment: "xxx"
}

// 检查评议限制
GET /api/v1/peer-reviews/limits?reviewerId=xxx

// 举报作弊
POST /api/v1/cheating-reports
{
  reportedUserId: "xxx",
  type: "TEST_CHEATING",
  evidence: "xxx"
}
```

---

## 八、v0.8新增：最终信用计算API

### 8.1 信用计算公式

```typescript
// 最终信用 = 初始信用×衰减 + 长期信用
const calculateFinalCredit = (
  initialScore: number,
  longTermScore: number,
  monthsSinceRegistration: number
): number => {
  // 初始信用权重：3个月内1.0，之后每月递减0.1，最低0.1
  const initialWeight = Math.max(
    1.0 - Math.max(0, monthsSinceRegistration - 3) * 0.1,
    0.1
  )
  
  const longTermWeight = 1.0 - initialWeight
  
  return initialScore * initialWeight + longTermScore * longTermWeight
}

// 长期信用计算
const calculateLongTermCredit = (user: User): number => {
  // 长期信用 = 项目数×0.2 + 成功率×0.5 + 好评率×0.3
  const projectScore = Math.min(user.totalProjects * 10, 100)
  const successScore = user.approvalRate * 100
  const reviewScore = user.goodReviewRate * 100
  
  return projectScore * 0.2 + successScore * 0.5 + reviewScore * 0.3
}
```

### 8.2 信用查询API

```typescript
// 获取用户最终信用
GET /api/v1/users/:id/credit

// 响应示例
{
  "initialScore": 86,
  "initialWeight": 0.7,
  "initialExpiresAt": "2026-05-18",
  "longTermScore": 92,
  "finalScore": 87.8,
  "creditHistory": [
    {
      "date": "2026-02-15",
      "change": "+100",
      "source": "项目完成",
      "description": "AI代码审查工具环节1"
    }
  ]
}

// 获取信用历史
GET /api/v1/users/:id/credit-history?limit=100

// 获取信用排名
GET /api/v1/users/credit-rankings?type=participant&limit=100
```

---

**文档版本**: v0.8
**更新日期**: 2026-02-18
**核心原则**：优秀的人的经验以Skill方式用于项目各环节

---

## 九、项目发起全流程Skill相关数据模型

### 9.1 项目模板Skill表

```typescript
// 9.1.1 项目模板表
model ProjectTemplate {
  id              String    @id @default(uuid())
  name            String    // 模板名称
  description     String    // 模板描述
  authorId        String
  author          User      @relation(fields: [authorId], references: [id])
  
  // 模板类型
  type            ProjectTemplateType
  
  // 模板结构
  stages          Json      // 环节列表
  defaultTasks   Json      // 默认任务配置
  milestones      Json      // 里程碑配置
  
  // 推荐的Skill
  recommendedSkills String[] // 推荐的Skill列表
  
  // 统计
  usageCount      Int       @default(0)
  avgRating       Float?
  
  // 开源信息
  license         String    @default("MIT")
  repoUrl         String?
  
  // 状态
  status          ProjectTemplateStatus @default(DRAFT)
  
  createdAt       DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  @@map("project_templates")
}

enum ProjectTemplateType {
  WEB_DEV           // Web开发
  MOBILE_APP        // 移动端开发
  DATA_ANALYSIS     // 数据分析
  API_DEV           // API开发
  ML_PROJECT        // 机器学习项目
  CUSTOM            // 自定义
}

enum ProjectTemplateStatus {
  DRAFT
  PUBLISHED
  DEPRECATED
}

// 9.1.2 项目模板使用记录
model ProjectTemplateUsage {
  id              String    @id @default(uuid())
  
  templateId     String
  template        ProjectTemplate @relation(fields: [templateId], references: [id])
  
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id])
  
  // 自定义配置
  customizations  Json?     // 对模板的自定义修改
  
  createdAt       DateTime  @default(now())
  
  @@unique([projectId])
  @@map("project_template_usages")
}
```

### 9.2 任务拆解Skill相关表

```typescript
// 9.2.1 任务拆解结果表
model TaskBreakdownResult {
  id              String    @id @default(uuid())
  
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id])
  
  // 使用的Skill
  skillId         String?
  skill           InitialCreditSkill? @relation(fields: [skillId], references: [id])
  
  // 输入
  projectDescription String   // 项目描述
  projectType      String    // 项目类型
  selectedTemplate String?   // 选择的模板
  
  // 输出
  suggestedTasks  Json      // 建议任务列表
  suggestedMilestones Json   // 建议里程碑
  
  // 评估
  complexity      ProjectComplexity @default(MEDIUM)
  estimatedDuration String?  // 预计工期
  
  // 发起人调整
  adjustedTasks   Json?     // 调整后的任务
  adjustedBudget  Float?     // 调整后的预算
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("task_breakdown_results")
}

enum ProjectComplexity {
  VERY_LOW
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

// 9.2.2 任务详情表
model TaskDetail {
  id              String    @id @default(uuid())
  
  breakdownResultId String
  breakdownResult  TaskBreakdownResult @relation(fields: [breakdownResultId], references: [id])
  
  // 任务信息
  name            String
  description     String
  stage           String    // 所属环节
  
  // 预算
  suggestedBudget Float?    // 建议预算
  finalBudget     Float     // 最终预算
  
  // 技能需求
  requiredSkills  String[]
  requiredLevel   String?   // 所需技能等级
  
  // 验收标准
  qualityStandard  Json?    // 质量标准
  
  // 工期
  estimatedHours  Int?
  deadline        DateTime?
  
  // 排序
  order          Int       @default(0)
  
  @@map("task_details")
}
```

### 9.3 预算评估Skill相关表

```typescript
// 9.3.1 预算评估结果表
model BudgetEstimateResult {
  id              String    @id @default(uuid())
  
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id])
  
  // 使用的Skill
  skillId         String?
  skill           InitialCreditSkill? @relation(fields: [skillId], references: [id])
  
  // 输入
  taskCount       Int       // 任务数量
  complexity      ProjectComplexity
  duration        String    // 预计工期
  
  // 评估结果
  minBudget       Float     // 最低预算
  maxBudget       Float     // 最高预算
  recommendedBudget Float    // 推荐预算
  
  // 详细分解
  budgetBreakdown Json      // 预算分解
  // {
  //   "stage1": 3000,
  //   "stage2": 4000,
  //   "stage3": 3000
  // }
  
  // 历史参考
  historicalData Json?     // 历史项目参考
  // {
  //   "similarProjects": 15,
  //   "avgBudget": 10000,
  //   "minBudget": 8000,
  //   "maxBudget": 15000
  // }
  
  // 风险提示
  riskWarnings     String[]
  
  // 发起人调整
  finalBudget     Float?    // 最终设置预算
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("budget_estimate_results")
}

// 9.3.2 预算调整记录
model BudgetAdjustment {
  id              String    @id @default(uuid())
  
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id])
  
  // 调整信息
  originalBudget  Float
  adjustedBudget  Float
  adjustmentReason String?
  
  // 时间
  adjustedAt     DateTime  @default(now())
  
  @@map("budget_adjustments")
}
```

### 9.4 项目发起相关API

```typescript
// 9.4.1 项目模板API
GET /api/v1/project-templates                    // 获取模板列表
GET /api/v1/project-templates/:id             // 获取模板详情
POST /api/v1/project-templates                // 创建模板
PUT /api/v1/project-templates/:id             // 更新模板
DELETE /api/v1/project-templates/:id           // 删除模板

// 使用模板创建项目
POST /api/v1/projects/from-template
{
  templateId: "xxx",
  project: {
    title: "xxx",
    description: "xxx"
  },
  customizations: {...}
}

// 9.4.2 任务拆解API
POST /api/v1/projects/:id/task-breakdown
{
  projectDescription: "xxx",
  projectType: "WEB_DEV",
  selectedTemplate: "xxx"
}
// 响应
{
  suggestedTasks: [...],
  suggestedMilestones: [...],
  complexity: "MEDIUM",
  estimatedDuration: "2周"
}

PUT /api/v1/projects/:id/task-breakdown
{
  adjustedTasks: [...],
  adjustedBudget: 10000
}

// 9.4.3 预算评估API
POST /api/v1/projects/:id/budget-estimate
{
  taskCount: 6,
  complexity: "MEDIUM",
  duration: "2周"
}
// 响应
{
  minBudget: 8000,
  maxBudget: 12000,
  recommendedBudget: 10000,
  budgetBreakdown: {...},
  historicalData: {...},
  riskWarnings: [...]
}

PUT /api/v1/projects/:id/budget
{
  finalBudget: 10000
}
```

### 9.5 Skill在项目全流程的分布

```typescript
// Skill在项目各环节的应用
const projectLifecycleSkills = {
  initiation: {
    projectTemplate: {
      description: "项目流程模板",
      examples: ["@ai-pm/web-dev-template", "@ai-pm/mobile-app-template"],
      purpose: "确定项目标准流程"
    },
    taskBreakdown: {
      description: "任务拆解Skill",
      examples: ["@ai-pm/task-breakdown", "@custom/user-task-breakdown"],
      purpose: "自动拆分任务"
    },
    budgetEstimate: {
      description: "预算评估Skill",
      examples: ["@ai-pm/budget-estimate", "@custom/user-budget-estimate"],
      purpose: "估算合理预算"
    },
    skillRequirement: {
      description: "技能需求Skill",
      examples: ["@ai-pm/skill-match"],
      purpose: "推荐所需技能"
    }
  },
  execution: {
    codeReview: {
      description: "代码审查Skill",
      examples: ["@ai-pm/code-review", "@custom/python-code-review"],
      purpose: "代码质量把关"
    },
    qualityCheck: {
      description: "质量检查Skill",
      examples: ["@ai-pm/quality-check"],
      purpose: "自动检查质量"
    },
    securityScan: {
      description: "安全扫描Skill",
      examples: ["@ai-pm/security-scan"],
      purpose: "安全漏洞检测"
    }
  },
  delivery: {
    reviewStandard: {
      description: "验收标准Skill",
      examples: ["@ai-pm/basic-review", "@ai-pm/security-review"],
      purpose: "定义验收标准"
    },
    testCoverage: {
      description: "测试覆盖Skill",
      examples: ["@ai-pm/test-coverage"],
      purpose: "评估测试覆盖"
    }
  },
  completion: {
    reportGenerate: {
      description: "报告生成Skill",
      examples: ["@ai-pm/report-generate"],
      purpose: "生成项目报告"
    }
  }
};
```

---

## 十、积分系统设计（v0.8更新）

### 10.1 双模式概述

| 维度 | 社区模式 | 企业模式 |
|------|---------|---------|
| **货币** | 积分 | 积分 |
| **充值** | 预留支付接口（后续对接） | 无需充值 |
| **结算** | 实时到账 | 定期汇总导出 |
| **提现** | 预留接口 | 不支持 |
| **抽成比例** | 5% | 3% |

### 10.2 积分流转模型

```
┌─────────────────┐
│   积分来源      │
├─────────────────┤
│ 发起人设置预算  │
│ 平台不收真实资金│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   平台托管      │
│  (仅记录数字)   │
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌──────┐  ┌──────┐
│发起人│  │参与者│
│扣积分│  │得积分│
└──────┘  └──────┘
         │
         ▼
┌─────────────────┐
│   积分明细      │
│  (全程记录)     │
└─────────────────┘
```

### 10.3 支付接口预留

```typescript
// 预留支付接口（后续对接真实支付）
interface PaymentGateway {
  // 充值接口
  deposit(amount: number): Promise<DepositResult>
  
  // 提现接口
  withdraw(amount: number, wallet: string): Promise<WithdrawResult>
  
  // 结算接口
  settle(participants: Settlement[]): Promise<SettlementResult>
  
  // 查询余额
  balance(userId: string): Promise<number>
}

// 当前实现：空壳接口，记录积分
const mockPaymentGateway: PaymentGateway = {
  deposit: async (amount) => ({ success: true, txId: 'mock_' + Date.now() }),
  withdraw: async (amount, wallet) => ({ success: true, txId: 'mock_' + Date.now() }),
  settle: async (participants) => ({ success: true }),
  balance: async (userId) => 0
}
```

### 10.4 企业模式积分配置

```typescript
interface EnterpriseConfig {
  // 积分汇率配置（可选）
  pointToMoneyRatio?: {
    rules: {
      unit: string      // "休假小时" | "现金元" | "其他"
      value: number     // 数值
      points: number    // 对应积分
    }[]
  }
  
  // 积分来源配置
  pointSources: {
    perTask: number    // 每完成任务获得积分
    perReview: number  // 每验收一次获得积分
    bonus: number[]    // 额外奖励配置
  }
}
```

### 10.5 积分流水数据模型

```typescript
model PointTransaction {
  id              String    @id @default(uuid())
  
  // 用户
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  // 关联
  projectId       String?
  project         Project?  @relation(fields: [projectId], references: [id])
  taskId          String?
  task            Task?    @relation(fields: [taskId], references: [id])
  
  // 积分变动
  amount          Int       // 变动数量（正/负）
  balanceBefore   Int       // 变动前余额
  balanceAfter    Int       // 变动后余额
  
  // 类型
  type            PointTransactionType
  
  // 说明
  description     String?
  
  // 时间
  createdAt       DateTime  @default(now())
  
  @@map("point_transactions")
}

enum PointTransactionType {
  PROJECT_INIT    // 项目启动（扣发起人）
  TASK_COMPLETE   // 任务完成（给参与者）
  REVIEW_REWARD   // 验收奖励（给发起人）
  BONUS          // 额外奖励
  PENALTY        // 惩罚扣分
  PLATFORM_FEE   // 平台抽成
  REFUND         // 退款
}
```
└─────────────────┘
```

**优势**：
- 接入简单：只需一个钱包地址，无需支付网关
- 无资质要求：不需要企业营业执照
- 全球可用：中国/海外都能用
- 透明可查：链上记录防止抵赖
- 手续费低：TRC20网络几美分

### 10.3 企业模式：纯积分

```
企业模式不需要真实货币流转，积分由企业配置：

┌─────────────────┐
│  企业配置积分   │
│  (后台管理)     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   参与者获积分  │
│  (完成任务)     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   积分兑换      │
│  (企业自定义)   │
└─────────────────┘
```

### 10.4 企业积分汇率配置

```typescript
interface EnterpriseConfig {
  // 积分汇率配置（可选）
  pointToMoneyRatio?: {
    // 例如：100积分 = 1小时休假
    // 或者：1000积分 = 100元奖金
    rules: {
      unit: string      // "休假小时" | "现金元" | "其他"
      value: number     // 数值
      points: number    // 对应积分
    }[]
  }
  
  // 积分来源配置
  pointSources: {
    perTask: number    // 每完成任务获得积分
    perReview: number  // 每验收一次获得积分
    bonus: number[]    // 额外奖励配置
  }
}
```

### 10.5 支付相关数据模型

```typescript
// 10.5.1 支付模式枚举
enum PaymentMode {
  COMMUNITY  // 社区模式：USDT
  ENTERPRISE // 企业模式：积分
}

// 10.5.2 USDT充值记录
model UsdtDeposit {
  id            String    @id @default(uuid())
  userId        String
  
  // 金额
  amount        Float     // USDT数量
  txHash        String    @unique // 链上交易hash
  
  // 状态
  status        DepositStatus @default(PENDING)
  confirmations Int       @default(0)
  
  // 转换
  points        Int       // 转换为积分
  
  // 时间
  createdAt     DateTime  @default(now())
  confirmedAt   DateTime?
  
  @@map("usdt_deposits")
}

enum DepositStatus {
  PENDING
  CONFIRMED
  FAILED
}

// 10.5.3 USDT提现记录
model UsdtWithdrawal {
  id            String    @id @default(uuid())
  userId        String
  
  // 金额
  amount        Float     // USDT数量
  points        Int       // 消耗积分
  
  // 钱包地址
  walletAddress String
  
  // 状态
  status        WithdrawalStatus @default(PENDING)
  txHash        String?
  
  // 时间
  createdAt     DateTime  @default(now())
  processedAt   DateTime?
  
  @@map("usdt_withdrawals")
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// 10.5.4 企业积分配置
model EnterprisePointConfig {
  id            String    @id @default(uuid())
  enterpriseId  String
  
  // 积分规则
  pointPerTask  Int       @default(100)
  pointPerReview Int      @default(10)
  
  // 兑换规则
  exchangeRules Json?     // 积分兑换规则
  
  // 状态
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("enterprise_point_configs")
}
```

---

## 十一、验收评估流程（v0.8优化）

### 11.1 验收核心原则

```
验收流程：
1. 参与者提交成果 → 2. 调用验收Skill → 3. Skill返回评估结果
                                              │
                                              ▼
4. 发起人确认 ─────────────────────────── 最终验收结果
     │
     ├── 接受Skill评估 → 验收通过
     └── 修改评估结果 → 验收通过（发起人保留最终决定权）
```

### 11.2 验收Skill执行流程

```typescript
interface ReviewProcess {
  // 步骤1：提交成果
  step1: {
    action: "participant_submits"
    output: "GitHub PR链接 + 交付说明"
  }
  
  // 步骤2：调用验收Skill
  step2: {
    action: "invoke_review_skill"
    input: {
      reviewStandardId: string
      deliverable: {
        prUrl: string
        description: string
        artifacts: string[]
      }
    }
    output: {
      scores: number[]        // 各项评分
      totalScore: number      // 总分
      feedback: string        // 详细反馈
      passed: boolean         // 是否通过
    }
  }
  
  // 步骤3：发起人确认（可修改结果）
  step3: {
    action: "initiator_confirms"
    options: {
      acceptSkillResult: boolean  // 是否接受Skill评估
      modifyScores?: {           // 修改评分（可选）
        index: number
        newScore: number
      }[]
      finalComment?: string      // 最终评价
    }
    output: "最终验收结果"
  }
}
```

### 11.3 发起人修改评估结果

```
场景：Skill评估给出4.2分，但发起人认为质量更好

操作：
1. 查看Skill评估详情
2. 手动调整各项评分
3. 添加评价说明
4. 确认最终结果

效果：
├─ Skill评估：4.2分（记录）
├─ 发起人调整：4.5分（生效）
└─ 最终结算：按4.5分计算
```

---

## 十二、AIAgent冷启动模拟（v0.8新增）

### 12.1 冷启动问题

```
问题：
├─ 新平台没有用户
├─ 没有项目 → 没有参与者
├─ 没有参与者 → 没有人做任务
└─ 恶性循环

解决方案：AIAgent模拟社区运行
```

### 12.2 AIAgent模拟角色

```typescript
interface AIAgentRoles {
  // 角色1：模拟发起人
  initiator: {
    behaviors: [
      "定期发布项目",
      "设置合理的预算",
      "按时验收任务",
      "给予合理的评价"
    ]
    config: {
      projectFrequency: "每天3-5个项目"
      budgetRange: "¥500-5000/任务"
      responseTime: "<24小时"
    }
  }
  
  // 角色2：模拟参与者
  participant: {
    behaviors: [
      "认领各类任务",
      "使用Skill完成交付",
      "按时提交成果",
      "参与Skill评价"
    ]
    config: {
      taskFrequency: "每天2-3个任务"
      completionRate: ">90%"
      qualityLevel: "良好"
    }
  }
  
  // 角色3：模拟Skill评价者
  reviewer: {
    behaviors: [
      "对提交的Skill给予评价",
      "提出改进建议",
      "维护Skill质量"
    ]
    config: {
      reviewFrequency: "每天10-20个Skill"
      qualityThreshold: "4.0分以上"
    }
  }
}
```

### 12.3 AIAgent运行模式

```
运行阶段：

阶段1：种子期（第1-2周）
├─ AIAgent主导：发布80%项目，认领70%任务
├─ 真实用户：发布20%项目，认领30%任务
└─ 目标：积累种子用户和项目

阶段2：成长期（第3-4周）
├─ AIAgent辅助：发布50%项目，认领50%任务
├─ 真实用户：发布50%项目，认领50%任务
└─ 目标：社区开始自运转

阶段3：成熟期（第5周起）
├─ AIAgent观察：仅处理异常情况
├─ 真实用户：发布90%+项目，认领90%+任务
└─ 目标：社区完全自运转
```

### 12.4 AIAgent配置

```typescript
interface AIAgentConfig {
  // 启用状态
  enabled: boolean
  
  // 运行模式
  mode: "aggressive" | "moderate" | "conservative"
  
  // 角色配置
  roles: {
    initiator: {
      enabled: boolean
      dailyProjects: number      // 每日发布项目数
      budgetRange: [number, number] // 预算范围
    }
    participant: {
      enabled: boolean
      dailyTasks: number         // 每日认领任务数
      completionRate: number    // 完成率
    }
    reviewer: {
      enabled: boolean
      dailyReviews: number       // 每日评价数
    }
  }
  
  // 过渡策略
  transition: {
    phase1: {
      duration: "2周"
      agentRatio: 0.8
    }
    phase2: {
      duration: "2周"
      agentRatio: 0.5
    }
    phase3: {
      duration: "持续"
      agentRatio: 0.1
    }
  }
}
```

---

**文档版本**: v0.8
**更新日期**: 2026-02-19
**核心原则**：优秀的人的经验以Skill方式用于项目各环节

---

## 十三、监控告警系统（v0.8新增）

### 13.1 监控架构（简化版）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         监控架构（简化）                                  │
│                                                                             │
│  基础监控：                                                              │
│  ├─ CPU使用率                                                          │
│  ├─ 内存使用率                                                         │
│  ├─ 磁盘使用率                                                         │
│  └─ 容器状态                                                           │
│                                                                             │
│  健康检查：                                                              │
│  ├─ /health - 服务健康状态                                             │
│  ├─ /ready - 就绪检查                                                  │
│  └─ /metrics - 基础指标                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 13.2 监控指标

| 指标 | 阈值 | 告警 |
|------|------|------|
| CPU | >80% | Warning |
| 内存 | >85% | Warning |
| 磁盘 | >90% | Warning |

### 13.3 健康检查接口

```typescript
// 基础健康检查
GET /health
// 响应
{
  "status": "healthy" | "unhealthy",
  "timestamp": "2026-02-19T02:00:00Z",
  "checks": {
    "database": "healthy"
  }
}

// 就绪检查
GET /ready
// 响应
{
  "ready": true
}

// 基础指标
GET /metrics
// 响应（Prometheus格式）
# HELP cpu_usage_percent CPU使用率
# TYPE cpu_usage_percent gauge
cpu_usage_percent 45.2
# HELP memory_usage_percent 内存使用率
# TYPE memory_usage_percent gauge
memory_usage_percent 62.8
```

### 13.4 Docker监控命令

```bash
# 快速查看容器状态
docker stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}\t{{.PIDs}}"

# 查看容器日志
docker logs -f <container_name>

# 健康检查
docker inspect --format='{{.State.Health.Status}}' <container_name>
```

### 13.5 告警通知（可选扩展）

```
当前设计：不做自动告警

后续可扩展：
├─ 邮件通知
├─ Slack/钉钉webhook
└─ Prometheus + AlertManager
```

---

## 十四、仓库验证方案（v0.8新增）

### 14.1 核心原则

```
验证策略：不做验证，只记录仓库地址

理由：
├─ 开源项目不绑定特定代码托管平台
├─ GitHub/GitLab/自建git都支持
├─ 简化实现复杂度
└─ 发起人验收时自己去查看代码

参与者提交：
├─ 仓库地址（https://github.com/xxx/yyy）
└─ 可选：分支名、commit hash

发起人验收：
├─ 自己访问仓库地址查看
├─ 验证代码是否符合需求
└─ 给出验收评价
```

### 14.2 仓库地址存储

```typescript
model TaskSubmission {
  id              String    @id @default(uuid())
  taskId          String
  
  // 仓库地址
  repoUrl         String    // https://github.com/xxx/yyy
  branch?: string           // 可选：分支名
  commitHash?: string       // 可选：commit hash
  
  // 说明
  description     String?   // 交付说明
  
  // 状态
  status          SubmissionStatus @default(SUBMITTED)
  
  // 时间
  submittedAt     DateTime  @default(now())
  
  @@map("task_submissions")
}

enum SubmissionStatus {
  SUBMITTED       // 已提交（等待验收）
  UNDER_REVIEW    // 验收中
  APPROVED        // 验收通过
  REJECTED        // 验收拒绝
  REVISION_REQUESTED // 要求修改
}
```

### 14.3 仓库地址验证（格式）

```typescript
// 只验证URL格式，不验证归属
const validateRepoUrl = (url: string): boolean => {
  // 支持的格式
  const patterns = [
    /^https:\/\/github\.com\/[\w-]+\/[\w.-]+\/?$/,  // GitHub
    /^https:\/\/gitlab\.com\/[\w-]+\/[\w.-]+\/?$/,   // GitLab
    /^https:\/\/[\w.-]+\/[\w-]+\/[\w.-]+\/?$/,        // 其他git服务
  ]
  
  return patterns.some(p => p.test(url))
}

// 示例
validateRepoUrl("https://github.com/user/repo")       // ✓ true
validateRepoUrl("https://gitlab.com/user/repo")      // ✓ true
validateRepoUrl("https://gitlab.com/user/repo/tree/main") // ✓ true
validateRepoUrl("not-a-url")                         // ✗ false
```

### 14.4 后续可扩展验证

```
当前：不做验证

后续可扩展：
├─ OAuth授权验证（验证仓库归属）
├─ Webhook集成（监听代码更新）
├─ Git克隆验证（实际拉取代码）
└─ 代码扫描集成（静态分析、安全扫描）
```

---

## 十五、AIAgent实现细节（v0.8新增）

### 15.1 核心原则

```
AIAgent定位：系统内置账户，模拟社区运行

角色：
├─ 发起人Agent：发布项目、验收任务
├─ 参与者Agent：认领任务、交付成果
└─ 评价者Agent：对Skill给予评价

运行策略：
├─ 种子期：Agent主导（80%项目/70%任务）
├─ 成长期：Agent辅助（50%项目/50%任务）
└─ 成熟期：Agent观察（仅处理异常）
```

### 15.2 AIAgent账户设计

```typescript
// AIAgent为系统内置账户，非真实用户
model AIAgent {
  id          String   @id @default(uuid())
  name        String   // "系统Agent-发起人" 等
  role        AIAgentRole
  isActive    Boolean  @default(true)
  
  // 配置
  config      Json     // Agent特定配置
  
  // 统计
  stats {
    projectsCreated: Int @default(0)
    tasksCompleted: Int @default(0)
    reviewsGiven: Int @default(0)
  }
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("ai_agents")
}

enum AIAgentRole {
  INITIATOR    // 发起人Agent
  PARTICIPANT  // 参与者Agent
  REVIEWER     // 评价者Agent
}
```

### 15.3 AIAgent配置

```typescript
interface AIAgentConfig {
  // 发起人Agent配置
  initiator: {
    dailyProjects: number        // 每日发布项目数
    budgetRange: [number, number] // 预算范围
    projectTypes: string[]       // 项目类型
  }
  
  // 参与者Agent配置
  participant: {
    dailyTasks: number         // 每日认领任务数
    completionRate: number      // 完成率
    qualityLevel: string        // 质量级别
  }
  
  // 评价者Agent配置
  reviewer: {
    dailyReviews: number       // 每日评价数
    qualityThreshold: number   // 质量阈值
  }
}

// 默认配置
const defaultAIAgentConfig: AIAgentConfig = {
  initiator: {
    dailyProjects: 3,
    budgetRange: [500, 5000],
    projectTypes: ["WEB_DEV", "API_DEV", "DATA_ANALYSIS"]
  },
  participant: {
    dailyTasks: 2,
    completionRate: 0.9,
    qualityLevel: "good"
  },
  reviewer: {
    dailyReviews: 10,
    qualityThreshold: 4.0
  }
}
```

### 15.4 AIAgent工作流程

#### 15.4.1 发起人Agent

```typescript
// 1. 生成项目需求（调用LLM）
const generateProject = async (): Promise<ProjectInput> => {
  const prompt = `生成一个开源项目需求，要求：
1. 项目类型：随机选择WEB_DEV/API_DEV/DATA_ANALYSIS
2. 预算：500-5000积分
3. 描述：详细但不复杂`
  
  const llmResponse = await callLLM(prompt)
  return parseProject(llmResponse)
}

// 2. 创建项目（调用API）
const createProject = async (input: ProjectInput) => {
  return await apiClient.createProject({
    title: input.title,
    description: input.description,
    mode: "COMMUNITY",
    budget: input.budget,
    milestones: input.milestones
  })
}

// 3. 验收任务（调用LLM+API）
const reviewTask = async (submission: TaskSubmission): Promise<ReviewResult> => {
  // 调用LLM生成验收评价
  const prompt = `这是一个任务交付物，请给出验收评价：
任务描述：${submission.task.description}
交付说明：${submission.description}
仓库地址：${submission.repoUrl}

请给出：
1. 是否通过验收
2. 评分（1-5分）
3. 评价说明`

  const llmResult = await callLLM(prompt)
  
  // 记录验收结果
  return await apiClient.submitReview({
    taskId: submission.taskId,
    passed: llmResult.passed,
    score: llmResult.score,
    comment: llmResult.comment
  })
}
```

#### 15.4.2 参与者Agent

```typescript
// 1. 搜索任务（调用API）
const findTasks = async (): Promise<Task[]> => {
  return await apiClient.listTasks({
    status: "OPEN",
    limit: 5
  })
}

// 2. 认领任务（调用API）
const claimTask = async (taskId: string) => {
  return await apiClient.claimTask(taskId)
}

// 3. 生成交付物（调用LLM）
const generateDeliverable = async (task: Task): Promise<TaskSubmission> => {
  // 调用LLM生成仓库地址和说明
  const prompt = `这是一个任务：
标题：${task.title}
描述：${task.description}
验收标准：${task.reviewStandard}

请生成一个虚拟的交付物：
1. 仓库地址（虚构的GitHub URL）
2. 交付说明（描述完成的工作）
3. 预估质量：良好`

  const llmResult = await callLLM(prompt)
  
  // 标记任务完成
  return await apiClient.submitTask({
    taskId: task.id,
    repoUrl: llmResult.repoUrl,
    description: llmResult.description
  })
}
```

#### 15.4.3 评价者Agent

```typescript
// 对Skill给予评价
const reviewSkill = async (skill: Skill): Promise<SkillReview> => {
  const prompt = `请评价这个Skill：
名称：${skill.name}
描述：${skill.description}
标签：${skill.tags}

请给出：
1. 评分（1-5分）
2. 评价说明
3. 改进建议`

  const llmResult = await callLLM(prompt)
  
  return await apiClient.rateSkill({
    skillId: skill.id,
    score: llmResult.score,
    comment: llmResult.comment
  })
}
```

### 15.5 AIAgent调度器

```typescript
// 定时调度AIAgent执行任务
class AIAgentScheduler {
  private timer: NodeJS.Timer
  
  start() {
    // 每小时检查一次
    this.timer = setInterval(() => this.run(), 60 * 60 * 1000)
  }
  
  stop() {
    clearInterval(this.timer)
  }
  
  async run() {
    const config = await getAIAgentConfig()
    const stats = await getCurrentStats()
    
    // 根据阶段决定运行比例
    const phase = determinePhase(stats)
    const ratio = getAgentRatio(phase)
    
    // 发起人Agent
    const initiatorTasks = Math.round(config.initiator.dailyProjects * ratio)
    await this.runInitiatorAgent(initiatorTasks)
    
    // 参与者Agent
    const participantTasks = Math.round(config.participant.dailyTasks * ratio)
    await this.runParticipantAgent(participantTasks)
    
    // 评价者Agent
    const reviewerTasks = config.reviewer.dailyReviews
    await this.runReviewerAgent(reviewerTasks)
  }
  
  private async runInitiatorAgent(count: number) {
    for (let i = 0; i < count; i++) {
      const project = await generateProject()
      await createProject(project)
    }
  }
  
  // ... 其他Agent实现
}

// 运行阶段判断
const determinePhase = (stats: Stats): Phase => {
  if (stats.totalUsers < 100) return "SEED"      // 种子期
  if (stats.totalUsers < 1000) return "GROWTH"   // 成长期
  return "MATURE"                                 // 成熟期
}

const getAgentRatio = (phase: Phase): number => {
  switch (phase) {
    case "SEED": return 0.8      // Agent主导
    case "GROWTH": return 0.5     // Agent辅助
    case "MATURE": return 0.1     // Agent观察
  }
}
```

### 15.6 AIAgent可见性

```
设计决策：Agent身份对用户可见

原因：
├─ 用户知道哪些是真实用户，哪些是Agent
├─ 避免误导用户
└─ 符合开源透明原则

展示方式：
├─ 项目列表：标注"系统发起"
├─ 任务列表：标注"系统认领"
└─ Skill评价：标注"系统评价"

用户可以选择：
├─ 隐藏系统项目（可选）
├─ 隐藏系统任务（可选）
└─ 纯看真实用户数据（可选）
```

---

**文档版本**: v0.8
**更新日期**: 2026-02-19
**核心原则**：优秀的人的经验以Skill方式用于项目各环节
