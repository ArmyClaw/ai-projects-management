# AI Project Management Platform - 架构设计文档 v0.7

> **版本说明**：基于v0.7需求设计的系统架构和技术选型  
> **核心原则**：一人+AI开发优先，开源社区易上手

---

## 一、技术选型决策

### 1.1 选型原则

```
选型优先级（一人+AI开发）：
├─ 1. 学习成本最低      → 避免复杂框架
├─ 2. 开发效率最高      → AI辅助代码生成
├─ 3. 全栈统一语言      → TypeScript一统前后端
├─ 4. 环境配置最简      → SQLite免安装
└─ 5. 社区易上手      → 文档友好、入门简单
```

### 1.2 最终技术栈

| 层级 | 技术选型 | 版本 | 选型理由 |
|------|----------|------|----------|
| **前端框架** | Vue 3 | 3.4+ | 学习成本低，AI生成代码质量高 |
| **前端语言** | TypeScript | 5.0+ | 类型安全，AI辅助友好 |
| **UI组件库** | Naive UI | 2.7+ | Vue生态、TypeScript友好、主题丰富 |
| **状态管理** | Pinia | 2.0+ | Vue官方推荐，API简洁 |
| **后端框架** | Fastify | 4.0+ | 高性能、低开销、TypeScript支持好 |
| **后端语言** | TypeScript | 5.0+ | 与前端统一，降低认知负担 |
| **ORM** | Prisma | 5.0+ | 类型自动生成、迁移简单、文档清晰 |
| **数据库(开发)** | SQLite | 3.44+ | 单文件、免安装、秒启动 |
| **数据库(生产)** | PostgreSQL | 15+ | 生产级、Prisma原生支持 |
| **AI集成** | Direct SDK | 最新 | 无需LangChain，增加复杂度 |
| **认证** | JWT | - | 简单、无状态 |
| **部署** | Docker | 24+ | 一键部署、环境一致 |
| **反向代理** | Nginx | 1.24+ | 稳定、配置简单 |

### 1.3 技术栈对比

#### 前端：Vue 3 vs React

| 维度 | Vue 3 | React | 结论 |
|------|-------|-------|------|
| 学习曲线 | ⭐⭐ 平缓 | ⭐⭐⭐ 陡峭 | Vue更适合 |
| AI生成代码 | ⭐⭐⭐ 良好 | ⭐⭐⭐⭐ 成熟 | 两者都好 |
| 文档中文 | ⭐⭐⭐⭐ 官方中文 | ⭐⭐⭐ 社区翻译 | Vue更友好 |
| **一人+AI** | ✅ 更适合 | ⚠️ 需要学习 | **Vue 3** |

#### 后端：Node.js vs Python

| 维度 | Node.js | Python | 结论 |
|------|---------|--------|------|
| 全栈统一 | ✅ TS统一 | ⚠️ 两种语言 | Node.js更优 |
| AI SDK支持 | ⭐⭐⭐⭐⭐ 官方完善 | ⭐⭐⭐⭐ 良好 | Node.js更优 |
| 学习成本 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ 简单 | Python更简单 |
| **一人+AI** | ✅ TS统一 | ⚠️ 需切换 | **Node.js** |

#### 数据库：SQLite vs PostgreSQL

| 维度 | SQLite | PostgreSQL | 结论 |
|------|--------|------------|------|
| 安装配置 | ⭐⭐⭐⭐⭐ 免安装 | ⭐⭐⭐ 需安装 | SQLite更优 |
| 开发体验 | ⭐⭐⭐⭐⭐ 单文件 | ⭐⭐⭐ 需要服务 | SQLite更优 |
| **一人+AI** | ✅ 开发首选 | ⚠️ 后期切换 | **SQLite开发** |

---

## 二、系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          系统整体架构                                       │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     客户端层 (Browser)                               │   │
│  │   ┌─────────────────────────────────────────────────────────────┐  │   │
│  │   │                  Vue 3 SPA 应用                             │  │   │
│  │   │  ├─ 页面路由 (Vue Router)                                 │  │   │
│  │   │  ├─ 状态管理 (Pinia)                                      │  │   │
│  │   │  ├─ HTTP请求 (Axios)                                       │  │   │
│  │   │  └─ UI组件 (Naive UI)                                      │  │   │
│  │   └─────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                      │
│                                    ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      API网关层 (Nginx)                             │   │
│  │   ├─ 静态文件服务                                                │   │
│  │   ├─ 反向代理                                                    │   │
│  │   ├─ SSL终结                                                     │   │
│  │   └─ 负载均衡 (单实例时跳过)                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                      │
│                                    ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      应用服务层 (Fastify)                          │   │
│  │   ┌─────────────────────────────────────────────────────────────┐  │   │
│  │   │                    RESTful API                               │  │   │
│  │   │  ├─ /api/auth     (认证模块)                              │  │   │
│  │   │  ├─ /api/users   (用户模块)                              │  │   │
│  │   │  ├─ /api/projects (项目模块)                              │  │   │
│  │   │  ├─ /api/tasks   (任务模块)                              │  │   │
│  │   │  ├─ /api/skills  (Skill模块)                             │  │   │
│  │   │  ├─ /api/costs   (成本模块)                              │  │   │
│  │   │  └─ /api/settlements (结算模块)                          │  │   │
│  │   └─────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                      │
│                                    ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      数据持久层 (Prisma ORM)                        │   │
│  │   ├─ 开发环境：SQLite (prisma/dev.db)                           │   │
│  │   └─ 生产环境：PostgreSQL (Docker)                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                      │
│              ┌─────────────────────┼─────────────────────┐              │
│              ▼                     ▼                     ▼              │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐   │
│  │   Claude API      │   │   DeepSeek API   │   │   GitHub API    │   │
│  └─────────────────┘   └─────────────────┘   └─────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 前后端分离架构

```
前端 (Vue 3 SPA)
    │
    │ HTTP REST API (JSON)
    ▼

后端 (Fastify REST API)
    │
    │ Prisma ORM
    ▼

数据库 (SQLite/PostgreSQL)
```

### 2.3 模块划分

```
src/
├── api/                    # REST API 路由
│   ├── auth/              # 认证模块
│   ├── users/             # 用户模块
│   ├── projects/          # 项目模块
│   ├── tasks/             # 任务模块
│   ├── skills/            # Skill模块
│   ├── costs/             # 成本模块
│   └── settlements/       # 结算模块
│
├── services/               # 业务逻辑层
├── repositories/           # 数据访问层
├── entities/              # 实体定义
├── middlewares/          # 中间件
├── utils/                 # 工具函数
└── types/                 # 类型定义
```

---

## 三、数据模型设计

### 3.1 核心数据表

#### 3.1.1 用户表 (users)

```typescript
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String
  avatar        String?
  role          Role      @default(PARTICIPANT)
  status        UserStatus @default(ACTIVE)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  projects      Project[]  @relation("ProjectInitiator")
  tasks         Task[]
  profiles      Profile[]
  settlements   Settlement[]
  costs         Cost[]
  
  @@map("users")
}

enum Role {
  INITIATOR
  PARTICIPANT
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
}
```

#### 3.1.2 项目表 (projects)

```typescript
model Project {
  id            String    @id @default(uuid())
  title         String
  description   String
  mode          ProjectMode @default(COMMUNITY)
  visibility    Visibility @default(PUBLIC)
  status        ProjectStatus @default(DRAFT)
  
  totalBudget   Float
  costPerTask   Float?
  preferredModels String[]
  
  initiatorId   String
  initiator     User      @relation("ProjectInitiator", fields: [initiatorId], references: [id])
  
  milestones    Milestone[]
  tasks         Task[]
  settlements   Settlement[]
  
  @@map("projects")
}

enum ProjectMode {
  COMMUNITY
  ENTERPRISE
}

enum Visibility {
  PUBLIC
  PRIVATE
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}
```

#### 3.1.3 环节表 (milestones)

```typescript
model Milestone {
  id            String    @id @default(uuid())
  name          String
  description   String
  budget       Float
  order         Int
  requiredSkills String[]
  minSkillLevel SkillLevel @default(L1)
  
  projectId     String
  project       Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  tasks         Task[]
  
  @@map("milestones")
}

enum SkillLevel {
  L1
  L2
  L3
  L4
}
```

#### 3.1.4 任务表 (tasks)

```typescript
model Task {
  id            String    @id @default(uuid())
  status        TaskStatus @default(PENDING)
  
  milestoneId   String
  milestone     Milestone  @relation(fields: [milestoneId], references: [id])
  
  assigneeId    String
  assignee      User       @relation(fields: [assigneeId], references: [id])
  
  skillConfig   Json
  modelUsed     String
  promptTemplate String
  
  totalTokens   Int       @default(0)
  totalCost     Float     @default(0)
  contribution  Float?
  
  startedAt    DateTime?
  submittedAt   DateTime?
  approvedAt   DateTime?
  
  deliverables  Deliverable[]
  costs         Cost[]
  
  @@map("tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}
```

#### 3.1.5 成本表 (costs)

```typescript
model Cost {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  taskId        String?
  task          Task?     @relation(fields: [taskId], references: [id])
  
  provider      String
  model         String
  inputTokens   Int
  outputTokens  Int
  totalTokens   Int
  cost          Float
  
  calledAt      DateTime  @default(now())
  
  @@map("costs")
}
```

#### 3.1.6 结算表 (settlements)

```typescript
model Settlement {
  id            String    @id @default(uuid())
  projectId     String
  project       Project    @relation(fields: [projectId], references: [id])
  userId        String
  user          User       @relation(fields: [userId], references: [id])
  taskId        String?
  task          Task?      @relation(fields: [taskId], references: [id])
  
  amount        Float
  currency      String    @default("CNY")
  status        SettlementStatus @default(PENDING)
  
  settledAt     DateTime?
  
  @@map("settlements")
}

enum SettlementStatus {
  PENDING
  COMPLETED
  FAILED
}
```

#### 3.1.7 用户档案表 (profiles)

```typescript
model Profile {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  skills        String[]
  expertise     String[]
  tools         String[]
  
  skillLevel    SkillLevel @default(L1)
  systemScore   Float     @default(0)
  
  onlineStatus  OnlineStatus @default(OFFLINE)
  lastActiveAt  DateTime?
  
  @@unique([userId])
  @@map("profiles")
}

enum OnlineStatus {
  ONLINE
  BUSY
  OFFLINE
}
```

---

## 四、API设计

### 4.1 API端点清单

#### 认证模块 (/api/v1/auth)

| 方法 | 端点 | 描述 |
|------|------|------|
| POST | /api/v1/auth/register | 注册 |
| POST | /api/v1/auth/login | 登录 |
| POST | /api/v1/auth/logout | 登出 |
| POST | /api/v1/auth/refresh | 刷新Token |
| GET | /api/v1/auth/me | 获取当前用户 |

#### 项目模块 (/api/v1/projects)

| 方法 | 端点 | 描述 | 权限 |
|------|------|------|------|
| POST | /api/v1/projects | 创建项目 | 登录用户 |
| GET | /api/v1/projects | 获取项目列表 | 公开 |
| GET | /api/v1/projects/:id | 获取项目详情 | 公开 |
| PUT | /api/v1/projects/:id | 更新项目 | 发起人 |
| PUT | /api/v1/projects/:id/status | 更新状态 | 发起人 |

#### 任务模块 (/api/v1/tasks)

| 方法 | 端点 | 描述 | 权限 |
|------|------|------|------|
| GET | /api/v1/tasks | 获取任务大厅 | 登录用户 |
| GET | /api/v1/tasks/my | 获取我的任务 | 登录用户 |
| POST | /api/v1/tasks/:id/claim | 认领任务 | 登录用户 |
| POST | /api/v1/tasks/:id/submit | 提交成果 | 参与者 |
| POST | /api/v1/tasks/:id/review | 发起人验收 | 发起人 |

#### 结算模块 (/api/v1/settlements)

| 方法 | 端点 | 描述 |
|------|------|------|
| GET | /api/v1/settlements | 获取结算记录 |
| GET | /api/v1/settlements/summary | 获取结算统计 |

#### 成本模块 (/api/v1/costs)

| 方法 | 端点 | 描述 |
|------|------|------|
| GET | /api/v1/costs | 获取成本记录 |
| GET | /api/v1/costs/summary | 获取成本统计 |

### 4.2 API响应格式

#### 成功响应

```json
{
  "success": true,
  "data": { ... },
  "meta": { "page": 1, "limit": 20, "total": 100 }
}
```

#### 错误响应

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "参数验证失败",
    "details": [{ "field": "email", "message": "邮箱格式不正确" }]
  }
}
```

---

## 五、部署架构

### 5.1 开发环境

```
本地开发环境：
├─ 前端：localhost:3000
├─ 后端：localhost:3001
└─ 数据库：SQLite文件 (./prisma/dev.db)
```

### 5.2 生产环境

```
生产环境架构：
┌─────────────────────────────────────────────────────────────┐
│                      Nginx (反向代理)                        │
│   端口: 80 (HTTP) / 443 (HTTPS)                           │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   Docker Compose                            │
│   ├─ api (Fastify):3001                                   │
│   ├─ db (PostgreSQL):5432                                  │
│   └─ redis (可选):6379                                     │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 Docker配置

#### docker-compose.yml

```yaml
version: '3.8'

services:
  api:
    build: ./api
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:pass@db:5432/app
    depends_on:
      - db

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=app
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

---

## 六、开发规范

### 6.1 项目结构

```
ai-project-management/
├── api/                    # 后端源码
│   ├── src/
│   │   ├── entities/     # 实体定义
│   │   ├── repositories/ # 数据访问
│   │   ├── services/     # 业务逻辑
│   │   ├── routes/       # 路由定义
│   │   ├── middlewares/  # 中间件
│   │   └── index.ts      # 入口文件
│   └── package.json
│
├── web/                    # 前端源码
│   ├── src/
│   │   ├── views/        # 页面组件
│   │   ├── components/   # 通用组件
│   │   ├── stores/       # Pinia Store
│   │   └── main.ts       # 入口文件
│   └── package.json
│
└── docker-compose.yml
```

### 6.2 Git规范

```
分支策略：
├─ main          # 主分支 (生产)
├─ develop       # 开发分支
└─ feature/*     # 功能分支

提交规范：
├─ feat: 新功能
├─ fix: Bug修复
├─ docs: 文档更新
└─ chore: 构建/工具
```

---

## 七、开发计划

### 7.1 开发阶段

| 阶段 | 内容 | 时间 |
|------|------|------|
| Phase 1 | 环境搭建 + 基础框架 | 1周 |
| Phase 2 | 核心功能开发 | 2-3周 |
| Phase 3 | 测试 + 修复 | 1周 |
| Phase 4 | 部署 + 上线 | 1周 |

### 7.2 功能优先级

```
MVP功能优先级：

P0 (必须)：
├─ 用户注册/登录
├─ 发起项目
├─ 任务大厅
├─ 任务认领
├─ Skill调用AI
├─ 人工审核
├─ 发起人验收
└─ 结算功能

P1 (应该)：
├─ 成本监控
├─ 质量评分
├─ 积分制
└─ 备份机制

P2 (可以有)：
├─ 项目加密
├─ 实时通知
└─ 数据分析
```

---

**文档版本**: v0.7
**更新日期**: 2026-02-18
**核心原则**：一人+AI开发优先，开源社区易上手
